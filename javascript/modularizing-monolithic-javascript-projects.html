<!DOCTYPE html>
<html>
  <head>

    <meta charset="utf-8"/>

    <!-- Media query magic - http://stackoverflow.com/questions/19945658/my-iphone-thinks-its-980px-wide -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="//cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="//load.sumome.com/" data-sumo-site-id="f3c81f006746fb000d45ff008ccf6600517dc0001fe60e0045e9200020854300" async="async"></script>

    <!--
    //// Stylesheets
     -->

    <!-- Fonts -->
    <link href="//fonts.googleapis.com/css?family=Open+Sans:600,400,300,200|Inconsolata|Ubuntu+Mono:400,700"
          rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <!-- code highlighting -->
    <link rel="stylesheet" href="//plot.ly/gh-pages/documentation/static/javascripts/codehighlight/styles/tomorrow.css">
    <link rel="stylesheet" type="text/css" href="//plot.ly/gh-pages/documentation/static/css/js-splash-highlight.css"/>

    <!-- Main Stylesheets -->
    <link rel="stylesheet" type="text/css" href="https://images.plot.ly/assets/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="https://plot.ly/gh-pages/documentation/static//css/main.css?version=6dfea547b0">

    <!-- LOCAL DEV STYLESHEET -->
    <!--<link rel="stylesheet" type="text/css" href="http://api.plotly.dev/all_static/css/main.css">-->

    <!-- Icon -->
    <link rel="shortcut icon" href="/images/plotly-ico.png" type="image/x-icon"/>


    <!-- META TAGS -->
    <!-- SEO Tags - title, meta_description -->
    <title>Modularizing monolithic javascript projects</title>
    <meta name="description" content="Plotly is the easiest way to graph and share your data.">

<!-- Bing tags -->
    <meta name="msvalidate.01" content="D319859A832F9F1D15A7646E2A42150A" />
<!-- Facebook tags -->
    <meta property="og:title" content="Modularizing monolithic javascript projects"/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content="http://help.plot.ly/images/twitter-default.png">
    <meta property="og:description" content="Plotly is the easiest way to graph and share your data."/>
    <meta property="og:url" />
    <meta property="fb:admins" content="1123751525"/>
    <meta property="fb:admins" content="22418"/>

<!-- twitter tags -->
    <meta name="twitter:card" content="photo" />
    <meta name="twitter:title" content="Modularizing monolithic javascript projects"/>
    <meta name="twitter:url" content="http://help.plot.lyjavascript/modularizing-monolithic-javascript-projects"/>
    <meta name="twitter:description" content="Plotly is the easiest way to graph and share your data."/>
    <meta name="twitter:image" content="http://help.plot.ly/images/twitter-default.png">
    <meta name="twitter:site" content="@plotlygraphs"/>

<!-- Favicon -->
    <link rel="shortcut icon" href="https://plot.ly/gh-pages/documentation/static//images/plotly-ico.png?v=2" />



    

    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
            integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
            crossorigin="anonymous"></script>


</head>

  <head>
  <!-- <link rel="stylesheet" type="text/css" href="https://plot.ly/gh-pages/documentation/static//css/state.css"> -->
  </head>

  <body>
  <div id="header" style="
  background-image: url('https://images.plot.ly/excel/plotlyjs/plotlyjs-banner-background.png');
  background-repeat: no-repeat;
  background-size: cover;
  max-width: 100%;
  background-position: center top;
  width: 100%;
  height: 350px;
  position: relative;
  ">

  <div class="headerbar">

  <div class="headerbar-leftside">
      <a href="https://plot.ly/feed/" class="logo" target="_blank">
          <i class="ploticon-plotlylogo"></i>
          <em>plotly</em>
      </a>
  </div>

  <div class="headerbar-rightside hidesmall">


      <a href="/alpha/workspace" id="toolsignin" class="headerbar-nav-item --product-header" target="_self">Sign In</a>

      <a class="button --enterprise-quaternary" href="/alpha/workspace" id="signup" target="_self">
        SIGN UP
      </a>
    
      <a href="#" onmouseover="dropDownMenu('create-menu')" onmouseout="hideDropDownMenu('create-menu')" target="_self">
      <span class="headerbar-nav-item ">&plus; CREATE</span><span class="caret"></span>
      </a>

          <nav id="create-menu" role="menu" class="dropdown-menu" onmouseover="dropDownMenu('create-menu')" onmouseout="hideDropDownMenu('create-menu')" style="display:none; margin-left: 225px;">
              <a href="/alpha/workspace" class="dropdown-menu-item" target="_blank">CHART</a>
              <a href="/dashboards" class="dropdown-menu-item" target="_blank">DASHBOARD</a>
              <a href="/powerpoint-online/" class="dropdown-menu-item" target="_blank">PRESENTATION</a>
              <a href="/organize/?create=notebook" class="dropdown-menu-item" target="_blank">JUPYTER NOTEBOOK</a>
              <a href="/alpha/workspace/?upload=sql" class="dropdown-menu-item" target="_blank">DATABASE QUERY</a>
          </nav>
    
      
        <a class="button" href="https://plot.ly/products/cloud/">
          UPGRADE
        </a>
      

  </div>

  <div class="headerbar-nav hidesmall">

      <a href="https://plot.ly/feed/" target="_blank">
      <span class="headerbar-nav-item ">Feed</span>
      </a>

      <a href="https://plot.ly/products/cloud/" target="_blank">
      <span class="headerbar-nav-item ">Pricing</span></span>
      </a>

      <a href="https:/plot.ly/dashboards/" target="_blank">
      <span class="headerbar-nav-item ">Dashboards</span></span>
      </a>

      <a href="https://plot.ly/api/" onmouseover="dropDownMenu('api-menu')" onmouseout="hideDropDownMenu('api-menu')" target="_self">
      <span class="headerbar-nav-item ">API</span><span class="caret"></span>
      </a>

          <nav id="api-menu" role="menu" class="dropdown-menu" onmouseover="dropDownMenu('api-menu')" onmouseout="hideDropDownMenu('api-menu')" style="display:none; margin-left: 225px;">
              <a href="/python" class="dropdown-menu-item" target="_blank">PYTHON</a>
              <a href="/r" class="dropdown-menu-item" target="_blank">R</a>
              <a href="/matlab" class="dropdown-menu-item" target="_blank">MATLAB</a>
              <a href="/javascript-graphing-library" class="dropdown-menu-item" target="_blank">JAVASCRIPT</a>
              <a href="/api" class="dropdown-menu-item" target="_blank">MORE</a>
          </nav>

  </div>

  <div class="hamburger">
    <a href='#popmenufull' onclick='return clickfullmenu();'>
      <div id="harburger-menu"></div>
    </a>

  </div>

</div>

<!-- POP UP MENU -->
  <div id="popmenufull" style="display:none;">
      <div class="popupheader">
          <div class="headerbar-leftside">
            <a href="/feed/" class="logo">
              <i class="ploticon-plotlylogo"></i>
              <em>plotly</em>
            </a>
          </div>
          <a href='#popmenufull' onclick='return clickfullmenu();'>
          <div class="close"><img alt="close" src="http://i.imgur.com/esVZHwn.png"></div> </a>
      </div>

      <div class="popupmenu">
        <ul>
          <li><a href="https://plot.ly/feed/">Explore</a></li>
          <li><a href="https://plot.ly/products/cloud/">Pricing</a></li>

          <div onmouseover="dropDownMenu('sub-industries')" onmouseout="hideDropDownMenu('sub-industries')">
            <li><a href="https://plot.ly/products/industries/">Industries</a></li>
            <div class="sub-popmenu" id="sub-industries" style="display:none;">
                <ul class="no-margin">
                  <li class="no-margin"><a href="https://plot.ly/products/industries/finance/">FINANCE</a></li>
                  <li class="no-margin"><a href="https://plot.ly/products/industries/insurance/">INSURANCE</a></li>
                  <li class="no-margin"><a href="https://plot.ly/products/industries/aerospace/">AEROSPACE</a></li>
                  <li class="no-margin"><a href="https://plot.ly/products/industries/energy/">ENERGY</a></li>
                  <li class="no-margin"><a href="https://plot.ly/products/industries/research-and-development/">RESEARCH &amp; DEVELOPMENT</a></li>
                  <li class="no-margin"><a href="https://plot.ly/products/industries/automotive/">AUTOMOTIVE</a></li>
                  <li class="no-margin"><a href="https://plot.ly/products/industries/government-and-public/">GOVERNMENT</a></li>
                  <li class="no-margin"><a href="https://plot.ly/products/industries/pharma/">PHARMA &amp; COMPUTATIONAL BIOLOGY</a></li>
                  <li class="no-margin"><a href="https://plot.ly/products/industries/journalism/">JOURNALISM</a></li>
                  <li class="no-margin"><a href="https://plot.ly/products/industries/business-intelligence/">BUSINESS INTELLIGENCE</a></li>
                </ul>
            </div>
          </div>
          <div onmouseover="dropDownMenu('sub-api')" onmouseout="hideDropDownMenu('sub-api')">
            <li><a href="https://plot.ly/api/">API</a></li>
            <div class="sub-popmenu" id="sub-api" style="display:none;">
              <ul class="no-margin">
                <li class="no-margin"><a href="/python">PYTHON</a></li>
                <li class="no-margin"><a href="/r">R</a></li>
                <li class="no-margin"><a href="/matlab">MATLAB</a></li>
                <li class="no-margin"><a href="/javascript">JAVASCRIPT</a></li>
                <li class="no-margin"><a href="/api">MORE</a></li>
              </ul>
            </div>
          </div>
        </ul>
      </div>

  </div>

  <!-- POPUP MENU FULL PAGE -->
  <script>
  function clickfullmenu(){
    var thediv=document.getElementById('popmenufull');
    if(thediv.style.display == "none"){
      thediv.style.display = "";
    }else{
      thediv.style.display = "none";
    }
    return false;
  };
  </script>

  <!-- Drop Down Menu -->
  <script>
  function dropDownMenu(divID){
    var chosenDiv = document.getElementById(divID);
    console.log(chosenDiv);
    if(chosenDiv.style.display == "none"){
      chosenDiv.style.display = "block";
    }
  };
  function hideDropDownMenu(divID){
    var chosenDiv = document.getElementById(divID);
    console.log(chosenDiv);
    if(chosenDiv.style.display == "block"){
      chosenDiv.style.display = "none";
    }
  }
  </script>

  <script>
  console.log('got this');
    var hamburgerDiv = document.getElementById('harburger-menu');
    var currentUrl = window.location.href;
    var newImg = document.createElement('img');
    if (currentUrl === 'https://plot.ly/javascript/' ) {
        newImg.setAttribute('src', 'https://plot.ly/gh-pages/documentation/static//images/white-hamburger-bg-transparent.png');
        newImg.setAttribute('alt', 'Menu');
        newImg.setAttribute('id', 'hamburgerlink');
        newImg.setAttribute('onmouseover', 'this.src="https://plot.ly/gh-pages/documentation/static//images/blue-hamburger-bg-transparent.png"');
        newImg.setAttribute('onmouseout', 'this.src="https://plot.ly/gh-pages/documentation/static//images/white-hamburger-bg-transparent.png"');
        hamburgerDiv.appendChild(newImg);
    } else {
        newImg.setAttribute('src', 'http://i.imgur.com/o7Mxj6T.png');
        newImg.setAttribute('alt', 'Menu');
        newImg.setAttribute('id', 'hamburgerlink');
        newImg.setAttribute('onmouseover', 'this.src="http://i.imgur.com/gj2TtuI.png"');
        newImg.setAttribute('onmouseout', 'this.src="http://i.imgur.com/o7Mxj6T.png"');
        hamburgerDiv.appendChild(newImg);
    }

  </script>

  <div style="
    background-image: linear-gradient(0deg, rgba(100,91,158, 0.89)  0%, rgba(58,124,187, 0.89) 100%);
    width: 100%;
    height: 100%;
  "></div>

    <!-- Lang Banner -->
    <div class="header-large--wrap">
    <div class="header--blue-bg">


        <div class="--image"></div>
        <div class="header--meta-content">
            
            <h2 class="special-header">
                plotly.js
            </h2>
            

            
            <p>The open source JavaScript graphing library that powers Plotly</p>
            
        </div>
    </div>
</div>


</div>

    <!-- sitemap -->
    <section class="--breadcrumb-container">
    <div class="--wrap">

        <!--
            Show this if page is too thin (hides breadcrumb list)
            Toggles sidebar slide in/out (see main.js)
        -->
        <a href="#" class="toggle-sidebar">
            <div class="icon">
                <svg style="width:24px;height:24px" viewBox="0 0 24 24">
                    <path fill="#000000" d="M5,13L9,17L7.6,18.42L1.18,12L7.6,5.58L9,7L5,11H21V13H5M21,6V8H11V6H21M21,16V18H11V16H21Z" />
                </svg>
            </div>
            <span class="show">Show Sidebar</span>
            <span class="hide">Hide Sidebar</span>
        </a>

        <!--
            Breadcrumb List
        -->
        <ul class="--breadcrumb-list">
            <li class="--breadcrumb-item">
                <div class="icon">
                    <svg style="width:24px;height:24px" viewbox="0 0 24 24">
                        <path fill="#000000" d="M15.07,11.25L14.17,12.17C13.45,12.89 13,13.5 13,15H11V14.5C11,13.39 11.45,12.39 12.17,11.67L13.41,10.41C13.78,10.05 14,9.55 14,9C14,7.89 13.1,7 12,7A2,2 0 0,0 10,9H8A4,4 0 0,1 12,5A4,4 0 0,1 16,9C16,9.88 15.64,10.67 15.07,11.25M13,19H11V17H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12C22,6.47 17.5,2 12,2Z"></path>
                    </svg>
                </div>
                <a href="http://help.plot.ly/"><span>Help</span></a>
            </li>
            <li class="--breadcrumb-item"><a href="/api/"><span>API Libraries</span></a></li>
            <li class="--breadcrumb-item">
                <a href="/javascript"  ><span>plotly.js</span></a>
            </li>
            <li class="--breadcrumb-item">
                <span>Modularizing monolithic javascript projects</span>
            </li>
        </ul>

        <!--
            Fork on Github :)
        -->
        <div class="--fork">
            
            <a id="forklink" href="https://github.com/plotly/plotly.js">
                <div class="icon">
                    <svg style="width:24px;height:24px" viewbox="0 0 24 24">
                        <path fill="#000000" d="M2.6,10.59L8.38,4.8L10.07,6.5C9.83,7.35 10.22,8.28 11,8.73V14.27C10.4,14.61 10,15.26 10,16A2,2 0 0,0 12,18A2,2 0 0,0 14,16C14,15.26 13.6,14.61 13,14.27V9.41L15.07,11.5C15,11.65 15,11.82 15,12A2,2 0 0,0 17,14A2,2 0 0,0 19,12A2,2 0 0,0 17,10C16.82,10 16.65,10 16.5,10.07L13.93,7.5C14.19,6.57 13.71,5.55 12.78,5.16C12.35,5 11.9,4.96 11.5,5.07L9.8,3.38L10.59,2.6C11.37,1.81 12.63,1.81 13.41,2.6L21.4,10.59C22.19,11.37 22.19,12.63 21.4,13.41L13.41,21.4C12.63,22.19 11.37,22.19 10.59,21.4L2.6,13.41C1.81,12.63 1.81,11.37 2.6,10.59Z"></path>
                    </svg>
                </div>
                <span>Fork on Github</span>
            </a>
            
    </div>
</section>

    <div class="allcontent">

      <div class="sectionseparator_white">
        <div class="container">



          <h1>Modularizing monolithic JS projects</h1>

<p>January 28, 2016</p>

<hr>

<blockquote>
<p><strong>tl;dr</strong> One javascript library&#39;s solution to approaching client-side
modularity using a mono-repo, one npm package and several CommonJS require-able
modules.</p>
</blockquote>

<p>The current era of client-side javascript stands between two major events: the
npm-modules explosion is a few years behind us, but wide-spread implementation
of native client-side modules by browsers is several years away.</p>

<p>In this context, bundling systems such as <a href="http://browserify.org/">browserify</a>
and <a href="https://webpack.github.io/">webpack</a> are, for most JS applications, a
necessity. This fact is especially true for applications that make use of
several npm packages at once. Moreover, it is crucial to optimize the resulting
bundles where semver-compatible third-party dependencies are shared and to
minimize code duplication for applications with heavy JS assets. Maintainers of
today&#39;s client-side libraries must adapt for the aforementioned realities to
provide the best experience for consumers using different bundling systems and
different library features.</p>

<p><a href="https://plot.ly/">Plotly</a>&#39;s open source javascript graphing library,
<a href="https://github.com/plotly/plotly.js">plotly.js</a>, includes multiple different
trace types (e.g. pie, scatter, bar, choropleth etc.) and as we add more types -
especially with the inclusion of WebGL types - our bundle size grows ever more
daunting. For a while, we&#39;ve received requests to implement a module system, and
have recently published our first modular
<a href="https://github.com/plotly/plotly.js/releases/tag/v1.5.0">release</a>, allowing
users to bundle only the specific
<a href="https://github.com/plotly/plotly.js/blob/49ea59fd3016b4b125855511a05abe92a2e69082/README.md#modules">trace modules</a>
they need.</p>

<p>In the past two months, we surveyed library design solutions in an effort to
provide the best experience for plotly.js consumers. We hope that our efforts
may help maintainers of other client-side libraries make judicious design
choices. We present Plotly&#39;s solution to client-side modularization below.</p>

<h3>Problem</h3>

<p>We state the problem as such:</p>

<blockquote>
<p>How to modularize a client-side JS library, mainly for the purpose of trimming
bundle size, in a way that adds as little friction as possible for both
library consumers and library developers?</p>
</blockquote>

<p>In addition, we formalize two additional requirements:</p>

<ul>
<li>Minimal overhead for browserify and webpack users</li>
<li>Optimal bundling via browserify and webpack</li>
</ul>

<p>Why prioritize browserify and webpack? Simply because they seem to be the most
used bundling systems. Source:</p>

<blockquote class="twitter-tweet" lang="en"><p lang="en" dir="ltr">... and
go!</p>&mdash; Matt DesLauriers (@mattdesl) <a
href="https://twitter.com/mattdesl/status/683753259992006656">January 3,
2016</a></blockquote>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>Moreover, browserify and webpack are the two most mature bundling systems
judging by their respective commit frequency and GitHub activity.</p>

<p>The <a href="http://rollupjs.org/">rollup</a> bundler offers an interesting take on
client-side bundling and is worth mentioning. Its <em>tree-shaking</em> feature,
which removes unused portions of code when used with <a href="https://developer.mozilla.org/en/docs/web/javascript/reference/statements/import">ES6
modules</a>
to, has the potential of solving many of the problems in modularization that we
will highlight below simply by using ES6 module definitions. While workarounds
do exist, converting plotly.js modules to ES6 syntax would increase the overhead
for browserify and webpack v1 users (note that webpack v2 is planning on
featuring <a href="http://www.2ality.com/2015/12/webpack-tree-shaking.html">tree-shaking</a>).
It simply feels too early for client-side libraries to adopt ES6 module
definitions. Nevertheless, keeping an eye on how rollup progresses will be
important in 2016. Its endorsement by the version 4 of
<a href="http://bost.ocks.org/mike/d3-plugin/">d3</a> may make ES6 module definitions
common place for the next generation of large client-side libraries.</p>

<h3>Possible solution 1</h3>

<p>Split up the library&#39;s modules into multiple repos, with each module linked to
its own npm package.</p>

<p>This solution is most common in the node.js world, however it is less-than-ideal
for a large client-side library. Having the different modules spread across
multiple repos increases friction during development. For example, how
should one write integration tests for a module that can&#39;t do anything on
its own? One could write up a testing repo requiring multiple modules, but
that would often result in several <code>npm link</code> and <code>npm publish</code> commands.
For a small team of maintainers like ours, this solution was quickly
discarded.</p>

<p><strong>Pros:</strong>
 - For a large project like plotly.js, we can&#39;t honestly think of any</p>

<p><strong>Cons:</strong>
 - That would have been a lot of work for us
 - Can&#39;t easily share testing and building resources from module to module
 - Possible code duplication unless the internal modules become npm packages too
   (more on that in the next section)</p>

<h3>Possible solution 2</h3>

<p>Another solution to the problem would place all the code under one <em>mono-repo</em>
and publish the different modules as distinct npm packages.</p>

<p>Three well-known projects are currently implementing this solution with slightly
different flavours: <a href="https://github.com/facebook/react">React</a>,
<a href="https://github.com/babel/babel">Babel</a> and
<a href="https://github.com/lodash/lodash">lodash</a>.</p>

<p>While React and Babel spawn multiple npm packages from inside their mono-repos,
the lodash team wrote a CLI utility named
<a href="https://github.com/lodash/lodash-cli">lodash-cli</a> to parse through their
mono-repo looking for all its public methods and their dependencies to
ultimately publish them on npm automatically (see
<a href="https://www.npmjs.com/browse/keyword/lodash-modularized">lodash-modularized</a>).</p>

<p>Mono-repos have several advantages. For instance, as pointed out in the Babel
<a href="https://github.com/babel/babel/blob/12b7a44796a504dbe5841473b899e499cae30749/doc/design/monorepo.md">design
docs</a>,
the different packages can easily share common resources such as testing
frameworks (who wants to <code>npm i karma</code> for each package in a project) and
development tooling which is a big plus for developers. In addition, issues are
reported in a single place instead of being spread over multiple GitHub
trackers.</p>

<p>However, mono-repos spawning multiple npm package may not be ideal for projects
with several shared internal modules, mainly because they are prone to code
duplication. To be more specific, imagine that the plotly.js repo spawned one
npm package per trace type along with a core package. Then, to make a custom
plotly.js bundle including only code to draw bar charts, one would:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">npm install plotly.js-core plotly.js-bar
</code></pre></div>
<p>and then</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">plotlyCore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'plotly.js-core'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">plotlyBar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'plotly.js-bar'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">customPlotly</span> <span class="o">=</span> <span class="nx">plotlyCore</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">plotlyBar</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">customPlotly</span><span class="p">;</span>
</code></pre></div>
<p>It is important to note that if these two modules required above have shared
dependencies (e.g. some internal helper function), these will be duplicated in
the resulting bundle unless (1) they themselves become published modules or (2)
are exposed on the core export (e.g. <code>plotlyCore</code> in the above example).</p>

<p>Both (1) and (2) have drawbacks. Publishing internal modules would result in extra
maintenance work while exposing more methods on the core export would result in
greater library footprint.</p>

<p>To sum up:</p>

<p><strong>Pros:</strong>
 - Able to share common resources (e.g. testing, development and build step)
 - Centralized GitHub issue tracker</p>

<p><strong>Cons:</strong>
 - Writing the script(s) needed to split and/or publish the individual packages
   from within the mono-repo is non-trivial. Hats off to the lodash team for
   pulling it off.
 - Internal modules are prone to code duplication in the resulting bundles.</p>

<h3>Possible solution 3</h3>

<p>Our solution!</p>

<p>To avoid the problems of code duplication and adding complication to project
management, we decided to opt for an easy to maintain <em>mono-repo</em> +
<em>mono-package</em> style solution.</p>

<p>With this solution, the end user can configure and build the final package as
they see fit, with only the trace types (e.g. bar, pie, histogram etc.) that
they require. The WebGL trace types - specifically ScatterGL and Mesh3D - add
nearly 100 KB to the bundle size and for many users, only one or two basic trace
types are needed.</p>

<p>Traces modules were originally loaded onto the <code>Plotly</code> core object when a
trace&#39;s <code>index.js</code> file was executed, so the whole trace module had a dependency
on <code>Plotly</code>.  To deal with this, we initially implemented a simple dependency
injection system where each trace&#39;s <code>index.js</code> exported a function that accepted
the <code>Plotly</code> dependency and passed it down to its children, then we could load
the ready-to-go trace onto <code>Plotly</code>.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">module</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Plotly</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">plot</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./plot'</span><span class="p">)(</span><span class="nx">Plotly</span><span class="p">),</span>
    <span class="na">attributes</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./attributes'</span><span class="p">)(</span><span class="nx">Plotly</span><span class="p">),</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>This worked well enough, but was more complex than it needed to be and required
us to wrap all the trace module code in functions. We quickly saw that
dependency injection could be completely avoided by changing dependencies on
<code>Plotly.____</code> to directly require the code needed, and invert the control flow
by moving the code that loads modules into a top-level <code>register</code> method. This
meant that the <code>index.js</code> of each trace could be greatly simplified to re-export
only the generalized methods that are used for drawing traces.</p>

<p>The downside of this solution is that the modules can&#39;t completely stand on
their own; nearly every trace module depends on code that is bundled in the
core. Lucky for us, in the year 2016, nearly everyone has a build step!</p>

<p>While the generally preferred way to ship a package is to include <code>build</code> and/or
<code>dist</code> directories, containing nothing but pure and clean javascript, we&#39;ve
added an additional <code>lib</code> directory that contains all the power-user-facing
parts. Inside, the files contain nothing more than re-exports, but this allows
for a much cleaner <code>require</code>&#39;s in end-user code. Users can pick and choose the
trace types they&#39;d like to use, register them with the plotly.js core module,
then re-export their own custom plotly.js module for use in their own code.
Example:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">plotlyCore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'plotly.js/lib/core'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">plotlyBar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'plotly.js/lib/bar'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">customPlotly</span> <span class="o">=</span> <span class="nx">plotlyCore</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">plotlyBar</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">customPlotly</span><span class="p">;</span>
</code></pre></div>
<p>If the need arises to use another trace type, all that needs to be done is to
add a new trace module to the <code>Plotly.register</code> call.</p>

<p>We also considered, putting the <code>lib</code> files at the repo&#39;s root. This would have
made the <code>require</code> statements even cleaner e.g. <code>require(&#39;plotly.js/core&#39;)</code>
instead of <code>require(&#39;plotly.js/lib/core&#39;)</code>. But considering the large number of
these <code>lib</code> files we have, we opt for a <code>lib</code> directory in order to not pollute
the repo&#39;s root. Note that the <code>&quot;main&quot;</code> package.json field cannot be set to a
directory (more info <a href="Mention%0Ahttps://github.com/nodejs/node/issues/3953">here</a>).</p>

<p>Our solution results in a minor increase in build time, but we feel that the
flexibility it allows is well worth the hit. Browserify and webpack both have
caching, while developing, so after an initial bundling, there is no appreciable
difference in bundling time compared to using a pre-built library.</p>

<p>Once working this out and getting everything to work smoothly, we were faced
with one more issue still: webpack. Many areas of the plotly.js use
<a href="https://github.com/stackgl/glslify">glslify</a> transforms, and unfortunately,
some of the plotly.js dependencies <em>rely on browserify to resolve transforms
specified in a package.json</em>. This was a problem that we puzzled over for quite
some time until <a href="https://github.com/hughsk">Hugh Kenedy</a> released
<a href="https://github.com/hughsk/ify-loader">ify-loader</a> for webpack. With this, as
webpack walks through source code and resolves <code>require</code>&#39;s it will check the
package.json <code>browserify</code> field for any necessary transforms and apply them
appropriately.</p>

<p><strong>Pros:</strong>
 - One repo (<strong>!!!</strong>)
 - No code duplication in resulting bundles</p>

<p><strong>Cons:</strong>
 - Consumers need to require the plotly.js modules with a longer path e.g.
   <code>require(&#39;plotly.js/lib/bar&#39;)</code>
 - Webpack users will need to add <a href="https://github.com/hughsk/ify-loader">ify-loader</a>
   to their config file</p>

<p>You can check out our latest (modular) <a href="https://github.com/plotly/plotly.js/releases/tag/v1.5.0">plotly.js release on GitHub</a>. If this is your first time hearing about plotly.js, check out our <a href="https://plot.ly/javascript">gallery and documentation</a>. We just recently open-sourced the project and you can learn more about our decision in our <a href="https://plot.ly/javascript/open-source-announcement">open-source announcement</a>.</p>

<p>Thanks for reading!</p>

<p><img src="https://images.plot.ly/excel/plotlyjs/plotlyjs-banner-background.png" alt="3D-chart"></p>


        </div>
      </div>
    </div>
    <footer>
<div class="plotly-footer" id="footer">
	<div class="row footerarea footer-top" style="z-index: 100; position: relative;">
		<div class="one column footcolumn space"> </div>
		<div class="two columns footcolumn respfooter">
			<h6 class="footer-heading">API</h6>
			<ul>
				<li><a  href="https://plot.ly/api/" target="_self">Documentation</a></li>
				<li><a  href="https://plot.ly/api/" target="_self">API Libraries</a></li>
				<li><a  href="https://plot.ly/rest/" target="_self">REST APIs</a></li>
				<li><a  href="https://plot.ly/javascript/" target="_self">Plotly.js</a></li>
				<li><a  href="https://plot.ly/workshop/" target="_self">Hardware</a></li>
			</ul>
		</div>
		<div class="two columns footcolumn respfooter">
			<h6 class="footer-heading">About Us</h6>
			<ul>
				<li><a href="https://plot.ly/company/team/" target="_self">Team</a></li>
				<li><a href="https://plot.ly/company/jobs/" target="_self">Careers</a></li>
				<li><a href="http://blog.plot.ly" target="_blank">Plotly Blog</a></li>
				<li><a href="http://moderndata.plot.ly" target="_blank">Modern Data</a></li>
			</ul>
		</div>
		<div class="two columns footcolumn respfooter">
			<h6 class="footer-heading">Help</h6>
			<ul>
				<li><a href="https://plot.ly/learn/" target="_self">Knowledge Base</a></li>
				<li><a href="https://plot.ly/benchmarks/" target="_self">Benchmarks</a></li>
				<li><a href="https://plot.ly/workshop/" target="_self">Workshop</a></li>
			</ul>
		</div>
		<div class="two columns footcolumn respfooter">
			<h6 class="footer-heading">Solutions</h6>
			<ul>
				<li><a href="https://plot.ly/product/plans/" target="_self">Plans &amp; Pricing</a></li>
				<li><a href="https://plot.ly/product/enterprise/" target="_self">Enterprise</a></li>
				<li><a href="https://plot.ly/online-graphing-and-statistics-for-educators/" target="_self">Education</a></li>
				<li><a href="https://plot.ly/product/plotlyjs/" target="_self">Plotly.js</a></li>
			</ul>
		</div>
		<div class="two columns footcolumn respfooter">
     		<h6 class="footer-heading">Connect</h6>
			<ul class="plotly-social-media-small">
				<li><a href="//twitter.com/plotlygraphs" target="_blank"><i class="icon-twitter social_icon"></i></a></li>
				<li><a href="//www.facebook.com/Plotly" target="_blank"><i class="icon-facebook social_icon"></i></a></li>
				<li><a href="//github.com/plotly" target="_blank"><i class="icon-github social_icon"></i></a></li>
				<li><a href="//linkedin.com/company/plotly" target="_blank"><i class="icon-linkedin social_icon"></i></a></li>
				<li><a href="//plus.google.com/+PlotLy" target="_blank"><i class="icon-google-plus  social_icon"></i></a></li>
			</ul>
		</div>
		<div class="one column footcolumn"></div>
	</div>

	<div class="row footerarea footer-bottom" style="z-index: 100; position: relative;">
		<div class="one column footcolumn space"> </div>
		<div class="four columns footcolumn"><p>Copyright &copy; 2015 Plotly. All rights reserved.</p></div>
		<div class="two columns footcolumn"><a href="https://plot.ly/terms-of-service/" target="_blank" ><p>Terms of Service</p></a></div>
		<div class="two columns footcolumn"><a href="https://plot.ly/privacy/" target="_blank"><p>Privacy Policy</p></a></div>


	</div>
</div>
</footer>



<!-- code highlighting -->
<script src="https://plot.ly/gh-pages/documentation/static//javascripts/codehighlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-39373211-1', 'auto');
  ga('send', 'pageview');
</script>

<script type="text/javascript">
$('pre').after('<a href="https://goo.gl/2wUZYZ" target="_blank" style="position:absolute;right:20px;">Support our open-source mission: <span style="color:darkviolet">Go Pro</span></a>')
</script>

<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-563d60eba90f0f45" async="async"></script>


  </body>
</html>
